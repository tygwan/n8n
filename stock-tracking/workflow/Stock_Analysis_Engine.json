{
  "name": "Stock_Analysis_Engine",
  "nodes": [
    {
      "id": "trigger",
      "name": "Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [0, 300],
      "parameters": {
        "inputSource": "passthrough"
      }
    },
    {
      "id": "classify_market",
      "name": "Classify Market",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 300],
      "parameters": {
        "language": "javaScript",
        "mode": "runOnceForAllItems",
        "jsCode": "// ì…ë ¥: { tickers: [\"AAPL\", \"005930\", \"TSLA\", \"000660\"] }\nconst input = $input.first().json;\nconst tickers = input.tickers || [];\n\nconst usTickers = [];\nconst krTickers = [];\n\ntickers.forEach(ticker => {\n  const t = ticker.trim().toUpperCase();\n  // í•œêµ­ ì£¼ì‹: ìˆ«ì 6ìë¦¬\n  if (/^\\d{6}$/.test(t)) {\n    krTickers.push(t);\n  }\n  // ë¯¸êµ­ ì£¼ì‹: ì˜ë¬¸ 1-5ìë¦¬\n  else if (/^[A-Z]{1,5}$/.test(t)) {\n    usTickers.push(t);\n  }\n});\n\nreturn [\n  {\n    json: {\n      us_tickers: usTickers,\n      kr_tickers: krTickers,\n      total_count: tickers.length\n    }\n  }\n];"
      }
    },
    {
      "id": "split_us",
      "name": "Split US Tickers",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [440, 200],
      "parameters": {
        "fieldToSplitOut": "us_tickers",
        "options": {}
      }
    },
    {
      "id": "split_kr",
      "name": "Split KR Tickers",
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [440, 400],
      "parameters": {
        "fieldToSplitOut": "kr_tickers",
        "options": {}
      }
    },
    {
      "id": "call_us_collector",
      "name": "Call US Collector",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [660, 200],
      "parameters": {
        "source": "database",
        "workflowId": {
          "__rl": true,
          "value": "",
          "mode": "list"
        },
        "options": {}
      }
    },
    {
      "id": "call_kr_collector",
      "name": "Call KR Collector",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [660, 400],
      "parameters": {
        "source": "database",
        "workflowId": {
          "__rl": true,
          "value": "",
          "mode": "list"
        },
        "options": {}
      }
    },
    {
      "id": "prepare_us_input",
      "name": "Prepare US Input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [550, 200],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "ticker", "name": "ticker", "value": "={{ $json }}", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "prepare_kr_input",
      "name": "Prepare KR Input",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [550, 400],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {"id": "ticker", "name": "ticker", "value": "={{ $json }}", "type": "string"}
          ]
        }
      }
    },
    {
      "id": "merge_all",
      "name": "Merge All Data",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [880, 300],
      "parameters": {
        "mode": "append",
        "options": {}
      }
    },
    {
      "id": "ai_analysis",
      "name": "AI Analysis",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [1100, 300],
      "parameters": {
        "options": {
          "systemMessage": "ë‹¹ì‹ ì€ ì „ë¬¸ ì£¼ì‹ ì• ë„ë¦¬ìŠ¤íŠ¸ì…ë‹ˆë‹¤.\n\n## ë¶„ì„ ê¸°ì¤€\n\n### 1. ê¸°ìˆ ì  ë¶„ì„ (40%)\n- RSI: 30 ì´í•˜ ê³¼ë§¤ë„(ë§¤ìˆ˜ ê¸°íšŒ), 70 ì´ìƒ ê³¼ë§¤ìˆ˜(ì£¼ì˜)\n- MACD: ì‹œê·¸ë„ ìƒí–¥ ëŒíŒŒ ê¸ì •, í•˜í–¥ ëŒíŒŒ ë¶€ì •\n- Bollinger Bands: í•˜ë‹¨ í„°ì¹˜ ì‹œ ë°˜ë“± ê°€ëŠ¥, ìƒë‹¨ ì´íƒˆ ì‹œ ê³¼ì—´\n- ì´ë™í‰ê· : ë‹¨ê¸°>ì¥ê¸° ê³¨ë“ í¬ë¡œìŠ¤ ê¸ì •\n- 52ì£¼ ìœ„ì¹˜: ì €ì  ê·¼ì²˜ ë§¤ë ¥ì \n\n### 2. í€ë”ë©˜í„¸ ë¶„ì„ (35%)\n- PER: ì—…ì¢… í‰ê·  ëŒ€ë¹„ í‰ê°€ (ë‚®ì„ìˆ˜ë¡ ì €í‰ê°€)\n- PBR: 1 ë¯¸ë§Œ ìì‚°ê°€ì¹˜ ëŒ€ë¹„ ì €í‰ê°€\n- ROE: 15% ì´ìƒ ìš°ìˆ˜\n- ë°°ë‹¹ìˆ˜ìµë¥ : 3% ì´ìƒ ë§¤ë ¥ì \n\n### 3. ë‰´ìŠ¤/ê°ì„± ë¶„ì„ (25%)\n- ê°ì„± ì ìˆ˜: ì–‘ìˆ˜ë©´ ê¸ì •ì  í™˜ê²½\n- ìµœê·¼ ê³µì‹œ/ë‰´ìŠ¤ ë‚´ìš© ê³ ë ¤\n\n## ì¶œë ¥ í˜•ì‹ (JSON)\n```json\n{\n  \"ticker\": \"ì¢…ëª©ì½”ë“œ\",\n  \"name\": \"ì¢…ëª©ëª…\",\n  \"market\": \"US ë˜ëŠ” KR\",\n  \"attractiveness_score\": 0-100,\n  \"recommendation\": \"strong_buy|buy|hold|sell|strong_sell\",\n  \"key_factors\": [\"í•µì‹¬ í¬ì¸íŠ¸ 3ê°œ\"],\n  \"risk_factors\": [\"ë¦¬ìŠ¤í¬ ìš”ì†Œ\"],\n  \"technical_summary\": \"ê¸°ìˆ ì  ë¶„ì„ ìš”ì•½\",\n  \"fundamental_summary\": \"í€ë”ë©˜í„¸ ìš”ì•½\",\n  \"target_price\": null,\n  \"stop_loss\": null,\n  \"investment_horizon\": \"swing|mid_term|long_term\"\n}\n```\n\nê° ì¢…ëª©ì— ëŒ€í•´ ìœ„ JSON í˜•ì‹ìœ¼ë¡œ ë¶„ì„í•´ì£¼ì„¸ìš”."
        },
        "promptType": "define",
        "text": "=ë‹¤ìŒ ì¢…ëª©ë“¤ì„ ë¶„ì„í•´ì£¼ì„¸ìš”:\n\n{{ JSON.stringify($input.all().map(item => item.json), null, 2) }}"
      }
    },
    {
      "id": "openai_model",
      "name": "OpenAI Model",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [1100, 520],
      "parameters": {
        "model": "gpt-4o",
        "options": {
          "temperature": 0.3
        }
      }
    },
    {
      "id": "parse_response",
      "name": "Parse AI Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1320, 300],
      "parameters": {
        "language": "javaScript",
        "mode": "runOnceForAllItems",
        "jsCode": "const aiResponse = $input.first().json.output || $input.first().json.text || '';\n\n// JSON ë¸”ë¡ ì¶”ì¶œ\nconst jsonMatches = aiResponse.match(/```json([\\s\\S]*?)```/g) || [];\nconst results = [];\n\njsonMatches.forEach(match => {\n  try {\n    const jsonStr = match.replace(/```json\\n?/g, '').replace(/```/g, '').trim();\n    const parsed = JSON.parse(jsonStr);\n    results.push({ json: parsed });\n  } catch (e) {\n    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ\n  }\n});\n\n// JSON ë¸”ë¡ì´ ì—†ìœ¼ë©´ ì „ì²´ë¥¼ íŒŒì‹± ì‹œë„\nif (results.length === 0) {\n  try {\n    // ë°°ì—´ í˜•íƒœë¡œ ëœ ê²½ìš°\n    const arrayMatch = aiResponse.match(/\\[([\\s\\S]*?)\\]/g);\n    if (arrayMatch) {\n      const parsed = JSON.parse(arrayMatch[0]);\n      if (Array.isArray(parsed)) {\n        parsed.forEach(item => results.push({ json: item }));\n      }\n    }\n  } catch (e) {\n    // íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì›ë³¸ í…ìŠ¤íŠ¸ ë°˜í™˜\n    results.push({ \n      json: { \n        raw_response: aiResponse,\n        parse_error: true \n      } \n    });\n  }\n}\n\nreturn results.length > 0 ? results : [{ json: { error: 'No valid analysis found' } }];"
      }
    },
    {
      "id": "filter_attractive",
      "name": "Filter Attractive Stocks",
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2,
      "position": [1540, 300],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "score_filter",
              "leftValue": "={{ $json.attractiveness_score }}",
              "rightValue": 60,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "format_report",
      "name": "Format Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1760, 300],
      "parameters": {
        "language": "javaScript",
        "mode": "runOnceForAllItems",
        "jsCode": "const items = $input.all();\nconst now = new Date().toISOString().split('T')[0];\n\nlet htmlReport = `ğŸ“Š <b>ì£¼ì‹ ë¶„ì„ ë¦¬í¬íŠ¸</b> (${now})\\n`;\nhtmlReport += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';\n\n// ì ìˆ˜ ê¸°ì¤€ ì •ë ¬\nconst sorted = items.sort((a, b) => \n  (b.json.attractiveness_score || 0) - (a.json.attractiveness_score || 0)\n);\n\nsorted.forEach((item, idx) => {\n  const s = item.json;\n  if (!s.ticker) return;\n  \n  const flag = s.market === 'US' ? 'ğŸ‡ºğŸ‡¸' : 'ğŸ‡°ğŸ‡·';\n  const scoreEmoji = s.attractiveness_score >= 80 ? 'ğŸŸ¢' : \n                     s.attractiveness_score >= 60 ? 'ğŸŸ¡' : 'ğŸ”´';\n  \n  const recMap = {\n    'strong_buy': 'âœ… ê°•ë ¥ë§¤ìˆ˜',\n    'buy': 'âœ… ë§¤ìˆ˜',\n    'hold': 'âš ï¸ ë³´ìœ ',\n    'sell': 'âŒ ë§¤ë„',\n    'strong_sell': 'âŒ ê°•ë ¥ë§¤ë„'\n  };\n  \n  htmlReport += `${flag} <b>${s.ticker}</b> | ${s.name || ''}\\n`;\n  htmlReport += `ğŸ“ˆ ë§¤ë ¥ë„: <b>${s.attractiveness_score || 'N/A'}/100</b> ${scoreEmoji}\\n\\n`;\n  \n  if (s.technical_summary) {\n    htmlReport += `ê¸°ìˆ ì : ${s.technical_summary}\\n`;\n  }\n  if (s.fundamental_summary) {\n    htmlReport += `í€ë”ë©˜í„¸: ${s.fundamental_summary}\\n`;\n  }\n  \n  htmlReport += `\\n${recMap[s.recommendation] || s.recommendation || ''}\\n`;\n  \n  if (s.key_factors && s.key_factors.length > 0) {\n    s.key_factors.forEach(f => {\n      htmlReport += `â€¢ ${f}\\n`;\n    });\n  }\n  \n  if (s.risk_factors && s.risk_factors.length > 0) {\n    htmlReport += `\\nâš ï¸ ë¦¬ìŠ¤í¬: ${s.risk_factors.join(', ')}\\n`;\n  }\n  \n  htmlReport += '\\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\\n\\n';\n});\n\nhtmlReport += 'ğŸ¤– AI ë¶„ì„ | íˆ¬ì ì°¸ê³ ìš©';\n\nreturn [{\n  json: {\n    report_html: htmlReport,\n    stocks_analyzed: sorted.map(s => s.json),\n    total_count: sorted.length,\n    generated_at: new Date().toISOString()\n  }\n}];"
      }
    },
    {
      "id": "sticky_note_1",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-80, 60],
      "parameters": {
        "content": "## ğŸ“Š Stock Analysis Engine\n\n### ì…ë ¥\n```json\n{\n  \"tickers\": [\"AAPL\", \"005930\", \"TSLA\"]\n}\n```\n\n### ì²˜ë¦¬ íë¦„\n1. ì‹œì¥ ë¶„ë¥˜ (US/KR)\n2. ê°œë³„ Collector í˜¸ì¶œ\n3. AI í†µí•© ë¶„ì„\n4. ë§¤ë ¥ë„ í•„í„°ë§\n5. ë¦¬í¬íŠ¸ ìƒì„±\n\n### ì¶œë ¥\nHTML í˜•ì‹ ë¦¬í¬íŠ¸ + ë¶„ì„ JSON",
        "width": 300,
        "height": 300
      }
    },
    {
      "id": "sticky_note_2",
      "name": "Workflow Setup",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [620, 60],
      "parameters": {
        "content": "## âš ï¸ ì›Œí¬í”Œë¡œìš° ì—°ê²°\n\n`Call US Collector` ë…¸ë“œì—ì„œ:\nâ†’ US_Stock_Data_Collector ì„ íƒ\n\n`Call KR Collector` ë…¸ë“œì—ì„œ:\nâ†’ KR_Stock_Data_Collector ì„ íƒ\n\n### OpenAI ì„¤ì •\n`OpenAI Model` ë…¸ë“œì—ì„œ:\nâ†’ OpenAI API Credentials ì—°ê²°",
        "width": 280,
        "height": 220
      }
    },
    {
      "id": "sticky_note_3",
      "name": "Filter Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1500, 100],
      "parameters": {
        "content": "## ğŸ¯ í•„í„°ë§ ê¸°ì¤€\n\në§¤ë ¥ë„ ì ìˆ˜ 60 ì´ìƒë§Œ\në¦¬í¬íŠ¸ì— í¬í•¨\n\n(ì¡°ì • ê°€ëŠ¥)",
        "width": 200,
        "height": 140
      }
    }
  ],
  "connections": {
    "Workflow Trigger": {
      "main": [[{"node": "Classify Market", "type": "main", "index": 0}]]
    },
    "Classify Market": {
      "main": [[
        {"node": "Split US Tickers", "type": "main", "index": 0},
        {"node": "Split KR Tickers", "type": "main", "index": 0}
      ]]
    },
    "Split US Tickers": {
      "main": [[{"node": "Prepare US Input", "type": "main", "index": 0}]]
    },
    "Split KR Tickers": {
      "main": [[{"node": "Prepare KR Input", "type": "main", "index": 0}]]
    },
    "Prepare US Input": {
      "main": [[{"node": "Call US Collector", "type": "main", "index": 0}]]
    },
    "Prepare KR Input": {
      "main": [[{"node": "Call KR Collector", "type": "main", "index": 0}]]
    },
    "Call US Collector": {
      "main": [[{"node": "Merge All Data", "type": "main", "index": 0}]]
    },
    "Call KR Collector": {
      "main": [[{"node": "Merge All Data", "type": "main", "index": 1}]]
    },
    "Merge All Data": {
      "main": [[{"node": "AI Analysis", "type": "main", "index": 0}]]
    },
    "OpenAI Model": {
      "ai_languageModel": [[{"node": "AI Analysis", "type": "ai_languageModel", "index": 0}]]
    },
    "AI Analysis": {
      "main": [[{"node": "Parse AI Response", "type": "main", "index": 0}]]
    },
    "Parse AI Response": {
      "main": [[{"node": "Filter Attractive Stocks", "type": "main", "index": 0}]]
    },
    "Filter Attractive Stocks": {
      "main": [[{"node": "Format Report", "type": "main", "index": 0}]]
    }
  },
  "settings": {"executionOrder": "v1"},
  "tags": [{"name": "stock-analysis"}, {"name": "ai-agent"}]
}
