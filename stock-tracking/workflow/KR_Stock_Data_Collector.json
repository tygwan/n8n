{
  "name": "KR_Stock_Data_Collector",
  "nodes": [
    {
      "id": "trigger",
      "name": "Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [0, 300],
      "parameters": {
        "inputSource": "passthrough"
      }
    },
    {
      "id": "set_config",
      "name": "Set Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [220, 300],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {
              "id": "ticker",
              "name": "ticker",
              "value": "={{ $json.ticker }}",
              "type": "string"
            },
            {
              "id": "kis_app_key",
              "name": "kis_app_key",
              "value": "YOUR_KIS_APP_KEY",
              "type": "string"
            },
            {
              "id": "kis_app_secret",
              "name": "kis_app_secret",
              "value": "YOUR_KIS_APP_SECRET",
              "type": "string"
            },
            {
              "id": "dart_api_key",
              "name": "dart_api_key",
              "value": "YOUR_DART_API_KEY",
              "type": "string"
            }
          ]
        },
        "includeOtherFields": true
      }
    },
    {
      "id": "get_kis_token",
      "name": "Get KIS Token",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [440, 200],
      "parameters": {
        "method": "POST",
        "url": "https://openapi.koreainvestment.com:9443/oauth2/tokenP",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "content-type", "value": "application/json"}
          ]
        },
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {"name": "grant_type", "value": "client_credentials"},
            {"name": "appkey", "value": "={{ $json.kis_app_key }}"},
            {"name": "appsecret", "value": "={{ $json.kis_app_secret }}"}
          ]
        },
        "options": {}
      }
    },
    {
      "id": "get_current_price",
      "name": "Get Current Price",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, 100],
      "parameters": {
        "method": "GET",
        "url": "=https://openapi.koreainvestment.com:9443/uapi/domestic-stock/v1/quotations/inquire-price?fid_cond_mrkt_div_code=J&fid_input_iscd={{ $('Set Config').item.json.ticker }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "authorization", "value": "=Bearer {{ $json.access_token }}"},
            {"name": "appkey", "value": "={{ $('Set Config').item.json.kis_app_key }}"},
            {"name": "appsecret", "value": "={{ $('Set Config').item.json.kis_app_secret }}"},
            {"name": "tr_id", "value": "FHKST01010100"}
          ]
        },
        "options": {}
      }
    },
    {
      "id": "get_daily_price",
      "name": "Get Daily Price (90days)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, 250],
      "parameters": {
        "method": "GET",
        "url": "=https://openapi.koreainvestment.com:9443/uapi/domestic-stock/v1/quotations/inquire-daily-price?fid_cond_mrkt_div_code=J&fid_input_iscd={{ $('Set Config').item.json.ticker }}&fid_period_div_code=D&fid_org_adj_prc=0",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "authorization", "value": "=Bearer {{ $('Get KIS Token').item.json.access_token }}"},
            {"name": "appkey", "value": "={{ $('Set Config').item.json.kis_app_key }}"},
            {"name": "appsecret", "value": "={{ $('Set Config').item.json.kis_app_secret }}"},
            {"name": "tr_id", "value": "FHKST01010400"}
          ]
        },
        "options": {}
      }
    },
    {
      "id": "get_financial",
      "name": "Get Financial Data",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, 400],
      "parameters": {
        "method": "GET",
        "url": "=https://openapi.koreainvestment.com:9443/uapi/domestic-stock/v1/finance/financial-ratio?fid_cond_mrkt_div_code=J&fid_input_iscd={{ $('Set Config').item.json.ticker }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {"name": "authorization", "value": "=Bearer {{ $('Get KIS Token').item.json.access_token }}"},
            {"name": "appkey", "value": "={{ $('Set Config').item.json.kis_app_key }}"},
            {"name": "appsecret", "value": "={{ $('Set Config').item.json.kis_app_secret }}"},
            {"name": "tr_id", "value": "FHKST66430300"}
          ]
        },
        "options": {}
      }
    },
    {
      "id": "get_dart_disclosure",
      "name": "Get DART Disclosure",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [660, 550],
      "parameters": {
        "method": "GET",
        "url": "=https://opendart.fss.or.kr/api/list.json?crtfc_key={{ $('Set Config').item.json.dart_api_key }}&corp_code={{ $('Set Config').item.json.ticker }}&bgn_de={{ $now.minus({days: 30}).format('yyyyMMdd') }}&end_de={{ $now.format('yyyyMMdd') }}&page_count=10",
        "options": {}
      }
    },
    {
      "id": "wait_parallel",
      "name": "Wait for All",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [900, 300],
      "parameters": {
        "mode": "combine",
        "combinationMode": "multiplex",
        "options": {}
      }
    },
    {
      "id": "calculate_indicators",
      "name": "Calculate Indicators",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1120, 300],
      "parameters": {
        "language": "javaScript",
        "mode": "runOnceForAllItems",
        "jsCode": "// ì…ë ¥ ë°ì´í„° ìˆ˜ì§‘\nconst allItems = $input.all();\nconst ticker = $('Set Config').first().json.ticker;\n\n// ê° API ì‘ë‹µì—ì„œ ë°ì´í„° ì¶”ì¶œ\nlet currentPriceData = {};\nlet dailyPriceData = [];\nlet financialData = {};\nlet dartData = { list: [] };\n\nfor (const item of allItems) {\n  const json = item.json;\n  // KIS í˜„ì¬ê°€ ì‘ë‹µ\n  if (json.output && json.output.stck_prpr) {\n    currentPriceData = json.output;\n  }\n  // KIS ì¼ë³„ ì‹œì„¸ ì‘ë‹µ\n  if (json.output && Array.isArray(json.output)) {\n    dailyPriceData = json.output;\n  }\n  // KIS ì¬ë¬´ë¹„ìœ¨ ì‘ë‹µ\n  if (json.output && json.output.per) {\n    financialData = json.output;\n  }\n  // DART ê³µì‹œ ì‘ë‹µ\n  if (json.list) {\n    dartData = json;\n  }\n}\n\n// ì¢…ê°€ ë°°ì—´ ì¶”ì¶œ (ì¼ë³„ ì‹œì„¸ì—ì„œ)\nconst closePrices = dailyPriceData\n  .map(d => parseFloat(d.stck_clpr))\n  .filter(p => !isNaN(p))\n  .reverse(); // ì˜¤ë˜ëœ ê²ƒë¶€í„° ì •ë ¬\n\n// RSI ê³„ì‚° (14ì¼)\nfunction calculateRSI(prices, period = 14) {\n  if (prices.length < period + 1) return null;\n  \n  let gains = 0, losses = 0;\n  \n  for (let i = prices.length - period; i < prices.length; i++) {\n    const change = prices[i] - prices[i - 1];\n    if (change > 0) gains += change;\n    else losses -= change;\n  }\n  \n  const avgGain = gains / period;\n  const avgLoss = losses / period;\n  \n  if (avgLoss === 0) return 100;\n  const rs = avgGain / avgLoss;\n  return 100 - (100 / (1 + rs));\n}\n\n// ì´ë™í‰ê·  ê³„ì‚°\nfunction calculateSMA(prices, period) {\n  if (prices.length < period) return null;\n  const slice = prices.slice(-period);\n  return slice.reduce((a, b) => a + b, 0) / period;\n}\n\n// MACD ê³„ì‚° (12, 26, 9)\nfunction calculateMACD(prices) {\n  if (prices.length < 26) return { value: 0, signal: 0, histogram: 0 };\n  \n  // EMA ê³„ì‚°\n  function ema(data, period) {\n    const k = 2 / (period + 1);\n    let emaVal = data[0];\n    for (let i = 1; i < data.length; i++) {\n      emaVal = data[i] * k + emaVal * (1 - k);\n    }\n    return emaVal;\n  }\n  \n  const ema12 = ema(prices, 12);\n  const ema26 = ema(prices, 26);\n  const macdLine = ema12 - ema26;\n  \n  // ì‹œê·¸ë„ (ê°„ë‹¨í™”: ìµœê·¼ ê°’ ê¸°ì¤€)\n  const signal = macdLine * 0.9; // ê·¼ì‚¬ê°’\n  \n  return {\n    value: parseFloat(macdLine.toFixed(2)),\n    signal: parseFloat(signal.toFixed(2)),\n    histogram: parseFloat((macdLine - signal).toFixed(2))\n  };\n}\n\n// Bollinger Bands ê³„ì‚°\nfunction calculateBollinger(prices, period = 20, stdDev = 2) {\n  if (prices.length < period) return null;\n  \n  const slice = prices.slice(-period);\n  const sma = slice.reduce((a, b) => a + b, 0) / period;\n  \n  const squaredDiffs = slice.map(p => Math.pow(p - sma, 2));\n  const variance = squaredDiffs.reduce((a, b) => a + b, 0) / period;\n  const std = Math.sqrt(variance);\n  \n  return {\n    upper: parseFloat((sma + stdDev * std).toFixed(0)),\n    middle: parseFloat(sma.toFixed(0)),\n    lower: parseFloat((sma - stdDev * std).toFixed(0))\n  };\n}\n\n// ì§€í‘œ ê³„ì‚°\nconst rsi = calculateRSI(closePrices, 14);\nconst sma20 = calculateSMA(closePrices, 20);\nconst sma60 = calculateSMA(closePrices, 60);\nconst macd = calculateMACD(closePrices);\nconst bollinger = calculateBollinger(closePrices, 20);\n\n// í˜„ì¬ê°€\nconst currentPrice = parseFloat(currentPriceData.stck_prpr) || 0;\nconst changeRate = parseFloat(currentPriceData.prdy_ctrt) || 0;\nconst volume = parseInt(currentPriceData.acml_vol) || 0;\nconst high52w = parseFloat(currentPriceData.stck_hgpr) || 0;\nconst low52w = parseFloat(currentPriceData.stck_lwpr) || 0;\n\n// ì¶”ì„¸ íŒë‹¨\nlet trend = 'neutral';\nif (rsi !== null) {\n  if (rsi > 60 && macd.histogram > 0) trend = 'bullish';\n  else if (rsi < 40 && macd.histogram < 0) trend = 'bearish';\n}\n\n// BB ìœ„ì¹˜ ê³„ì‚°\nlet bbPosition = null;\nif (bollinger && currentPrice > 0) {\n  const range = bollinger.upper - bollinger.lower;\n  if (range > 0) {\n    bbPosition = ((currentPrice - bollinger.lower) / range * 100).toFixed(1);\n  }\n}\n\n// ê³µì‹œ ì •ë³´ ì²˜ë¦¬\nconst disclosures = (dartData.list || []).slice(0, 5).map(d => ({\n  title: d.report_nm,\n  date: d.rcept_dt\n}));\n\n// ë‰´ìŠ¤ ê°ì„± (ê³µì‹œ ê¸°ë°˜ ê°„ë‹¨ íŒë‹¨)\nlet sentimentScore = 0;\nconst positiveKeywords = ['ì¦ê°€', 'ìƒìŠ¹', 'í‘ì', 'ë°°ë‹¹', 'ì„±ì¥', 'ì‹ ê³ '];\nconst negativeKeywords = ['ê°ì†Œ', 'í•˜ë½', 'ì ì', 'ì†ì‹¤', 'ì² íšŒ', 'ì—°ê¸°'];\n\ndisclosures.forEach(d => {\n  positiveKeywords.forEach(k => { if (d.title?.includes(k)) sentimentScore += 0.1; });\n  negativeKeywords.forEach(k => { if (d.title?.includes(k)) sentimentScore -= 0.1; });\n});\nsentimentScore = Math.max(-1, Math.min(1, sentimentScore));\n\n// í†µí•© ìŠ¤í‚¤ë§ˆë¡œ ì •ê·œí™”\nconst normalizedData = {\n  ticker: ticker,\n  name: currentPriceData.hts_kor_isnm || ticker,\n  market: 'KR',\n  currency: 'KRW',\n  \n  // ê°€ê²© ì •ë³´\n  price: currentPrice,\n  change_pct: changeRate,\n  volume: volume,\n  high: parseFloat(currentPriceData.stck_hgpr) || 0,\n  low: parseFloat(currentPriceData.stck_lwpr) || 0,\n  \n  // ê¸°ìˆ ì  ì§€í‘œ\n  technical: {\n    rsi: rsi ? parseFloat(rsi.toFixed(2)) : null,\n    rsi_signal: rsi > 70 ? 'overbought' : rsi < 30 ? 'oversold' : 'neutral',\n    macd: macd,\n    macd_signal: macd.histogram > 0 ? 'bullish' : 'bearish',\n    sma_20: sma20 ? parseFloat(sma20.toFixed(0)) : null,\n    sma_60: sma60 ? parseFloat(sma60.toFixed(0)) : null,\n    bollinger: bollinger,\n    bb_position: bbPosition,\n    trend: trend,\n    price_position_52w: high52w > low52w ? \n      ((currentPrice - low52w) / (high52w - low52w) * 100).toFixed(1) : null\n  },\n  \n  // í€ë”ë©˜í„¸\n  fundamental: {\n    per: parseFloat(financialData.per) || parseFloat(currentPriceData.per) || null,\n    pbr: parseFloat(financialData.pbr) || parseFloat(currentPriceData.pbr) || null,\n    roe: parseFloat(financialData.roe) || null,\n    market_cap: parseInt(currentPriceData.hts_avls) * 100000000 || 0,\n    dividend_yield: parseFloat(financialData.dvd_yld) || null,\n    eps: parseFloat(currentPriceData.eps) || null,\n    sector: '',\n    industry: '',\n    beta: null,\n    week52_high: high52w,\n    week52_low: low52w\n  },\n  \n  // ë‰´ìŠ¤/ê°ì„± (ê³µì‹œ ê¸°ë°˜)\n  sentiment: {\n    score: parseFloat(sentimentScore.toFixed(3)),\n    label: sentimentScore > 0.15 ? 'positive' : sentimentScore < -0.15 ? 'negative' : 'neutral',\n    news_count: disclosures.length,\n    top_headlines: disclosures.map(d => `[${d.date}] ${d.title}`)\n  },\n  \n  // ë©”íƒ€ë°ì´í„°\n  collected_at: new Date().toISOString(),\n  data_source: 'KIS Developers, DART'\n};\n\nreturn [{ json: normalizedData }];"
      }
    },
    {
      "id": "sticky_note_1",
      "name": "Sticky Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-80, 60],
      "parameters": {
        "content": "## ğŸ‡°ğŸ‡· KR Stock Data Collector\n\n### ì…ë ¥\n```json\n{ \"ticker\": \"005930\" }\n```\n(ì‚¼ì„±ì „ì: 005930)\n\n### ìˆ˜ì§‘ ë°ì´í„°\n- ğŸ“ˆ í˜„ì¬ê°€ (KIS API)\n- ğŸ“Š ì¼ë³„ ì‹œì„¸ 90ì¼ (ê¸°ìˆ ì§€í‘œ ê³„ì‚°ìš©)\n- ğŸ’° ì¬ë¬´ë¹„ìœ¨ (PER, PBR, ROE)\n- ğŸ“° DART ê³µì‹œ\n\n### ì¶œë ¥\ní†µí•© ìŠ¤í‚¤ë§ˆ JSON (ë¯¸êµ­ ì£¼ì‹ê³¼ ë™ì¼ í˜•ì‹)",
        "width": 300,
        "height": 320
      }
    },
    {
      "id": "sticky_note_2",
      "name": "API Setup",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [200, 60],
      "parameters": {
        "content": "## âš ï¸ API Key ì„¤ì •\n\n### 1. KIS Developers\n`Set Config` ë…¸ë“œì—ì„œ:\n- `YOUR_KIS_APP_KEY`\n- `YOUR_KIS_APP_SECRET`\n\në°œê¸‰: https://apiportal.koreainvestment.com\n(í•œêµ­íˆ¬ìì¦ê¶Œ ê³„ì¢Œ í•„ìš”)\n\n### 2. DART API\n- `YOUR_DART_API_KEY`\n\në°œê¸‰: https://opendart.fss.or.kr\n(ë¬´ë£Œ 10,000 calls/day)",
        "width": 280,
        "height": 300
      }
    },
    {
      "id": "sticky_note_3",
      "name": "Note Code",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1080, 60],
      "parameters": {
        "content": "## ğŸ“Š ìì²´ ê³„ì‚° ì§€í‘œ\n\n- RSI (14ì¼)\n- SMA (20ì¼, 60ì¼)\n- MACD (12, 26, 9)\n- Bollinger Bands (20ì¼)\n\nKIS APIì—ì„œ ì¼ë³„ ì‹œì„¸ë¥¼\në°›ì•„ì„œ Code ë…¸ë“œì—ì„œ ê³„ì‚°",
        "width": 240,
        "height": 200
      }
    }
  ],
  "connections": {
    "Workflow Trigger": {
      "main": [[{"node": "Set Config", "type": "main", "index": 0}]]
    },
    "Set Config": {
      "main": [[{"node": "Get KIS Token", "type": "main", "index": 0}]]
    },
    "Get KIS Token": {
      "main": [[
        {"node": "Get Current Price", "type": "main", "index": 0},
        {"node": "Get Daily Price (90days)", "type": "main", "index": 0},
        {"node": "Get Financial Data", "type": "main", "index": 0},
        {"node": "Get DART Disclosure", "type": "main", "index": 0}
      ]]
    },
    "Get Current Price": {"main": [[{"node": "Wait for All", "type": "main", "index": 0}]]},
    "Get Daily Price (90days)": {"main": [[{"node": "Wait for All", "type": "main", "index": 0}]]},
    "Get Financial Data": {"main": [[{"node": "Wait for All", "type": "main", "index": 0}]]},
    "Get DART Disclosure": {"main": [[{"node": "Wait for All", "type": "main", "index": 0}]]},
    "Wait for All": {"main": [[{"node": "Calculate Indicators", "type": "main", "index": 0}]]}
  },
  "settings": {"executionOrder": "v1"},
  "tags": [{"name": "stock-analysis"}, {"name": "kr-market"}]
}
