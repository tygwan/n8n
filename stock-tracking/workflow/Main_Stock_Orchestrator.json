{
  "name": "Main_Stock_Orchestrator",
  "nodes": [
    {
      "id": "schedule_trigger",
      "name": "Schedule Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 300],
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 2
            }
          ]
        }
      }
    },
    {
      "id": "manual_trigger",
      "name": "Manual Trigger",
      "type": "n8n-nodes-base.manualTrigger",
      "typeVersion": 1,
      "position": [0, 500]
    },
    {
      "id": "telegram_config",
      "name": "Telegram Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [220, 400],
      "parameters": {
        "mode": "manual",
        "assignments": {
          "assignments": [
            {
              "id": "bot_chat_id",
              "name": "bot_chat_id",
              "value": "YOUR_TELEGRAM_CHAT_ID",
              "type": "string"
            },
            {
              "id": "channel_usernames",
              "name": "channel_usernames",
              "value": "channel1,channel2,channel3",
              "type": "string"
            }
          ]
        }
      }
    },
    {
      "id": "fetch_messages",
      "name": "Fetch Channel Messages",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 400],
      "parameters": {
        "language": "javaScript",
        "mode": "runOnceForAllItems",
        "jsCode": "/*\n * TelePilot ì»¤ë®¤ë‹ˆí‹° ë…¸ë“œ ì‚¬ìš© ì‹œ:\n * ì´ Code ë…¸ë“œë¥¼ TelePilot ë…¸ë“œë¡œ êµì²´í•˜ì„¸ìš”.\n * \n * í˜„ì¬ëŠ” ìˆ˜ë™ í…ŒìŠ¤íŠ¸ìš© mock ë°ì´í„°ì…ë‹ˆë‹¤.\n * ì‹¤ì œ êµ¬í˜„ ì‹œ TelePilotìœ¼ë¡œ ì±„ë„ ë©”ì‹œì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.\n */\n\n// Mock ë°ì´í„° (í…ŒìŠ¤íŠ¸ìš©)\nconst mockMessages = [\n  {\n    text: \"ì˜¤ëŠ˜ NVDA ì‹¤ì  ë°œí‘œ í›„ ê¸‰ë“±í–ˆë„¤ìš”. AI ë°˜ë„ì²´ ìˆ˜ìš” ê³„ì† ì¦ê°€ ì¤‘\",\n    date: new Date().toISOString()\n  },\n  {\n    text: \"ì‚¼ì„±ì „ì(005930) HBM ì–‘ì‚° ë³¸ê²©í™”, 2ë¶„ê¸° ì‹¤ì  ê°œì„  ê¸°ëŒ€\",\n    date: new Date().toISOString()\n  },\n  {\n    text: \"AAPL ì•„ì´í°16 íŒë§¤ í˜¸ì¡°, ëª©í‘œê°€ ìƒí–¥\",\n    date: new Date().toISOString()\n  },\n  {\n    text: \"SKí•˜ì´ë‹‰ìŠ¤(000660) AI ë©”ëª¨ë¦¬ ìˆ˜ì£¼ ì¦ê°€ë¡œ ì£¼ê°€ ìƒìŠ¹\",\n    date: new Date().toISOString()\n  },\n  {\n    text: \"TSLA ììœ¨ì£¼í–‰ ì—…ë°ì´íŠ¸ ë°œí‘œ ì˜ˆì •, ê´€ì‹¬ ì¢…ëª©\",\n    date: new Date().toISOString()\n  },\n  {\n    text: \"ë„¤ì´ë²„(035420) ë¼ì¸ì•¼í›„ ì´ìŠˆ í•´ê²° ê¸°ëŒ€ê°\",\n    date: new Date().toISOString()\n  }\n];\n\n// ìµœê·¼ 2ì‹œê°„ ë©”ì‹œì§€ë§Œ í•„í„°ë§ (ì‹¤ì œ êµ¬í˜„ ì‹œ)\nconst twoHoursAgo = new Date(Date.now() - 2 * 60 * 60 * 1000);\nconst recentMessages = mockMessages.filter(m => \n  new Date(m.date) > twoHoursAgo\n);\n\nreturn [{\n  json: {\n    messages: recentMessages,\n    channel_count: 1,\n    message_count: recentMessages.length,\n    fetched_at: new Date().toISOString()\n  }\n}];\n\n/*\n * TelePilot ì‚¬ìš© ì‹œ ì„¤ì •:\n * 1. TelePilot ë…¸ë“œ ì¶”ê°€\n * 2. Operation: Get Messages\n * 3. Chat: ì±„ë„ username ë˜ëŠ” ID\n * 4. Limit: 100\n */"
      }
    },
    {
      "id": "extract_tickers",
      "name": "Extract Tickers with AI",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [660, 400],
      "parameters": {
        "options": {
          "systemMessage": "ë‹¹ì‹ ì€ ì£¼ì‹ ì¢…ëª© ì¶”ì¶œ ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\nì£¼ì–´ì§„ í…ìŠ¤íŠ¸ì—ì„œ ì£¼ì‹ í‹°ì»¤/ì¢…ëª©ì½”ë“œë¥¼ ì¶”ì¶œí•˜ì„¸ìš”.\n\n## ê·œì¹™\n1. ë¯¸êµ­ ì£¼ì‹: ì˜ë¬¸ ëŒ€ë¬¸ì 1-5ìë¦¬ (AAPL, NVDA, TSLA ë“±)\n2. í•œêµ­ ì£¼ì‹: ìˆ«ì 6ìë¦¬ (005930, 000660 ë“±)\n3. ì¢…ëª©ëª…ì´ ì–¸ê¸‰ë˜ë©´ í‹°ì»¤ë¡œ ë³€í™˜:\n   - ì‚¼ì„±ì „ì â†’ 005930\n   - SKí•˜ì´ë‹‰ìŠ¤ â†’ 000660\n   - ë„¤ì´ë²„ â†’ 035420\n   - ì¹´ì¹´ì˜¤ â†’ 035720\n   - LGì—ë„ˆì§€ì†”ë£¨ì…˜ â†’ 373220\n   - í˜„ëŒ€ì°¨ â†’ 005380\n   - ê¸°ì•„ â†’ 000270\n   - ì…€íŠ¸ë¦¬ì˜¨ â†’ 068270\n   - í¬ìŠ¤ì½”í™€ë”©ìŠ¤ â†’ 005490\n   - KBê¸ˆìœµ â†’ 105560\n\n## ì¶œë ¥ í˜•ì‹ (JSONë§Œ)\n```json\n{\n  \"tickers\": [\"AAPL\", \"005930\", \"NVDA\"],\n  \"mentions\": [\n    {\"ticker\": \"AAPL\", \"context\": \"ì•„ì´í°16 íŒë§¤ í˜¸ì¡°\"},\n    {\"ticker\": \"005930\", \"context\": \"HBM ì–‘ì‚° ë³¸ê²©í™”\"}\n  ]\n}\n```\n\nì¤‘ë³µ ì œê±°í•˜ê³ , í™•ì‹¤í•œ ì¢…ëª©ë§Œ í¬í•¨í•˜ì„¸ìš”."
        },
        "promptType": "define",
        "text": "=ë‹¤ìŒ ë©”ì‹œì§€ë“¤ì—ì„œ ì£¼ì‹ ì¢…ëª©ì„ ì¶”ì¶œí•˜ì„¸ìš”:\n\n{{ $json.messages.map(m => m.text).join('\\n\\n') }}"
      }
    },
    {
      "id": "openai_extractor",
      "name": "OpenAI Extractor",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1,
      "position": [660, 620],
      "parameters": {
        "model": "gpt-4o-mini",
        "options": {
          "temperature": 0.1
        }
      }
    },
    {
      "id": "parse_tickers",
      "name": "Parse Tickers",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 400],
      "parameters": {
        "language": "javaScript",
        "mode": "runOnceForAllItems",
        "jsCode": "const aiResponse = $input.first().json.output || $input.first().json.text || '';\n\nlet tickers = [];\nlet mentions = [];\n\n// JSON ì¶”ì¶œ ì‹œë„\ntry {\n  const jsonMatch = aiResponse.match(/```json([\\s\\S]*?)```/);\n  if (jsonMatch) {\n    const parsed = JSON.parse(jsonMatch[1].trim());\n    tickers = parsed.tickers || [];\n    mentions = parsed.mentions || [];\n  } else {\n    // JSON ë¸”ë¡ ì—†ì´ ì§ì ‘ íŒŒì‹±\n    const directParse = JSON.parse(aiResponse);\n    tickers = directParse.tickers || [];\n    mentions = directParse.mentions || [];\n  }\n} catch (e) {\n  // ì •ê·œì‹ìœ¼ë¡œ í‹°ì»¤ ì§ì ‘ ì¶”ì¶œ\n  const usMatches = aiResponse.match(/\\b[A-Z]{1,5}\\b/g) || [];\n  const krMatches = aiResponse.match(/\\b\\d{6}\\b/g) || [];\n  \n  tickers = [...new Set([...usMatches, ...krMatches])];\n}\n\n// ì¤‘ë³µ ì œê±° ë° ìœ íš¨ì„± ê²€ì‚¬\nconst validTickers = [...new Set(tickers)].filter(t => {\n  const isUS = /^[A-Z]{1,5}$/.test(t);\n  const isKR = /^\\d{6}$/.test(t);\n  return isUS || isKR;\n});\n\nreturn [{\n  json: {\n    tickers: validTickers,\n    mentions: mentions,\n    count: validTickers.length,\n    extracted_at: new Date().toISOString()\n  }\n}];"
      }
    },
    {
      "id": "check_tickers",
      "name": "Has Tickers?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1100, 400],
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "ticker_check",
              "leftValue": "={{ $json.count }}",
              "rightValue": 0,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      }
    },
    {
      "id": "call_analysis_engine",
      "name": "Call Analysis Engine",
      "type": "n8n-nodes-base.executeWorkflow",
      "typeVersion": 1.1,
      "position": [1320, 300],
      "parameters": {
        "source": "database",
        "workflowId": {
          "__rl": true,
          "value": "",
          "mode": "list"
        },
        "options": {}
      }
    },
    {
      "id": "send_telegram",
      "name": "Send to Telegram",
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [1540, 300],
      "parameters": {
        "operation": "sendMessage",
        "chatId": "={{ $('Telegram Config').item.json.bot_chat_id }}",
        "text": "={{ $json.report_html }}",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      }
    },
    {
      "id": "no_tickers_log",
      "name": "No Tickers Found",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1320, 500],
      "parameters": {}
    },
    {
      "id": "sticky_note_1",
      "name": "Overview",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [-100, 60],
      "parameters": {
        "content": "## ğŸ¯ Main Stock Orchestrator\n\n### ì „ì²´ íë¦„\n1. â° 2ì‹œê°„ë§ˆë‹¤ ìë™ ì‹¤í–‰\n2. ğŸ“± í…”ë ˆê·¸ë¨ ì±„ë„ì—ì„œ ë©”ì‹œì§€ ìˆ˜ì§‘\n3. ğŸ” AIë¡œ í‹°ì»¤ ì¶”ì¶œ\n4. ğŸ“Š ë¶„ì„ ì—”ì§„ í˜¸ì¶œ\n5. ğŸ“¤ ê²°ê³¼ í…”ë ˆê·¸ë¨ ì „ì†¡\n\n### ìˆ˜ë™ ì‹¤í–‰\nManual Triggerë¡œ ì¦‰ì‹œ ì‹¤í–‰ ê°€ëŠ¥",
        "width": 300,
        "height": 260
      }
    },
    {
      "id": "sticky_note_2",
      "name": "Config Setup",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [180, 160],
      "parameters": {
        "content": "## âš ï¸ ì„¤ì • í•„ìš”\n\n### Telegram Config ë…¸ë“œ\n- `YOUR_TELEGRAM_CHAT_ID`: ì•Œë¦¼ë°›ì„ ì±„íŒ… ID\n- `channel_usernames`: ìˆ˜ì§‘í•  ì±„ë„ë“¤\n\n### TelePilot ì„¤ì • (ì„ íƒ)\nì»¤ë®¤ë‹ˆí‹° ë…¸ë“œ ì„¤ì¹˜ í›„\n`Fetch Channel Messages` êµì²´",
        "width": 280,
        "height": 200
      }
    },
    {
      "id": "sticky_note_3",
      "name": "Workflow Connection",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [1280, 100],
      "parameters": {
        "content": "## ğŸ”— ì›Œí¬í”Œë¡œìš° ì—°ê²°\n\n`Call Analysis Engine` ë…¸ë“œì—ì„œ\nâ†’ Stock_Analysis_Engine ì„ íƒ\n\n### í…”ë ˆê·¸ë¨ Credentials\n`Send to Telegram` ë…¸ë“œì—ì„œ\nâ†’ Telegram Bot ì—°ê²°",
        "width": 260,
        "height": 180
      }
    },
    {
      "id": "sticky_note_4",
      "name": "TelePilot Note",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [400, 160],
      "parameters": {
        "content": "## ğŸ“± TelePilot ì»¤ë®¤ë‹ˆí‹° ë…¸ë“œ\n\ní˜„ì¬ëŠ” Mock ë°ì´í„° ì‚¬ìš© ì¤‘\n\n### ì‹¤ì œ êµ¬í˜„ ì‹œ:\n1. Settings â†’ Community nodes\n2. `@telepilotco/n8n-nodes-telepilot` ì„¤ì¹˜\n3. ì´ Code ë…¸ë“œë¥¼ TelePilotìœ¼ë¡œ êµì²´\n4. í…”ë ˆê·¸ë¨ ê³„ì • ì¸ì¦\n\n### MTProto í•„ìš” ì´ìœ \nì´ˆëŒ€ë°›ì€ ë¹„ê³µê°œ ì±„ë„ ì ‘ê·¼",
        "width": 300,
        "height": 240
      }
    }
  ],
  "connections": {
    "Schedule Trigger": {
      "main": [[{"node": "Telegram Config", "type": "main", "index": 0}]]
    },
    "Manual Trigger": {
      "main": [[{"node": "Telegram Config", "type": "main", "index": 0}]]
    },
    "Telegram Config": {
      "main": [[{"node": "Fetch Channel Messages", "type": "main", "index": 0}]]
    },
    "Fetch Channel Messages": {
      "main": [[{"node": "Extract Tickers with AI", "type": "main", "index": 0}]]
    },
    "OpenAI Extractor": {
      "ai_languageModel": [[{"node": "Extract Tickers with AI", "type": "ai_languageModel", "index": 0}]]
    },
    "Extract Tickers with AI": {
      "main": [[{"node": "Parse Tickers", "type": "main", "index": 0}]]
    },
    "Parse Tickers": {
      "main": [[{"node": "Has Tickers?", "type": "main", "index": 0}]]
    },
    "Has Tickers?": {
      "main": [
        [{"node": "Call Analysis Engine", "type": "main", "index": 0}],
        [{"node": "No Tickers Found", "type": "main", "index": 0}]
      ]
    },
    "Call Analysis Engine": {
      "main": [[{"node": "Send to Telegram", "type": "main", "index": 0}]]
    }
  },
  "settings": {"executionOrder": "v1"},
  "tags": [{"name": "stock-analysis"}, {"name": "orchestrator"}, {"name": "telegram"}]
}
