{
  "name": "Agent 2 - Monetization & Risk (FDS)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "days",
              "triggerAtHour": 6
            }
          ]
        }
      },
      "id": "schedule-daily",
      "name": "Daily 6AM Settlement",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://jsonplaceholder.typicode.com/posts",
        "options": {}
      },
      "id": "http-viewdata",
      "name": "Get Creator View Data (Mock)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [220, 300],
      "notes": "Replace with actual database/API for view counts"
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Mock creator performance data for reward calculation\nconst mockCreators = [\n  {\n    creator_id: 'creator_001',\n    username: '@sarah_lifestyle',\n    grade: 'S',\n    mission_id: 'MSN_001',\n    views: 125000,\n    likes: 8500,\n    comments: 420,\n    avg_watch_time: 12.5,\n    view_history: [5000, 8000, 15000, 35000, 62000], // hourly progression\n    peak_hour: 14,\n    category: 'Lifestyle'\n  },\n  {\n    creator_id: 'creator_002',\n    username: '@tech_mike',\n    grade: 'A',\n    mission_id: 'MSN_002',\n    views: 85000,\n    likes: 4200,\n    comments: 180,\n    avg_watch_time: 8.2,\n    view_history: [2000, 5000, 12000, 28000, 38000],\n    peak_hour: 20,\n    category: 'Tech'\n  },\n  {\n    creator_id: 'creator_003',\n    username: '@suspicious_user',\n    grade: 'B',\n    mission_id: 'MSN_003',\n    views: 95000,\n    likes: 150,\n    comments: 45,\n    avg_watch_time: 2.1,\n    view_history: [100, 200, 500, 94200], // suspicious spike at 3AM\n    peak_hour: 3,\n    category: 'Gaming'\n  },\n  {\n    creator_id: 'creator_004',\n    username: '@food_jenny',\n    grade: 'A',\n    mission_id: 'MSN_004',\n    views: 67000,\n    likes: 5100,\n    comments: 890,\n    avg_watch_time: 15.3,\n    view_history: [3000, 8000, 18000, 25000, 13000],\n    peak_hour: 12,\n    category: 'Food'\n  }\n];\n\n// Season/Event multiplier (e.g., Black Friday, Holiday)\nconst isPeakSeason = new Date().getMonth() === 10; // November\n\nreturn mockCreators.map(creator => ({\n  json: {\n    ...creator,\n    is_peak_season: isPeakSeason,\n    settlement_date: new Date().toISOString().split('T')[0],\n    engagement_rate: ((creator.likes + creator.comments) / creator.views * 100).toFixed(2)\n  }\n}));"
      },
      "id": "code-prepare",
      "name": "Prepare Settlement Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Dynamic Reward Calculation Logic\nconst item = $input.item.json;\n\n// Base rate: $0.5 per 1K views\nconst baseRate = 0.5;\n\n// Grade multipliers\nconst gradeMultiplier = {\n  'S': 1.5,\n  'A': 1.2,\n  'B': 1.0,\n  'C': 0.8\n};\n\n// Category bonuses\nconst categoryBonus = {\n  'Lifestyle': 1.1,\n  'Tech': 1.15,\n  'Food': 1.05,\n  'Gaming': 1.0,\n  'Beauty': 1.2\n};\n\n// Season multiplier\nconst seasonMultiplier = item.is_peak_season ? 1.3 : 1.0;\n\n// Calculate base reward\nlet baseReward = (item.views / 1000) * baseRate;\n\n// Apply multipliers\nlet finalReward = baseReward \n  * (gradeMultiplier[item.grade] || 1.0)\n  * (categoryBonus[item.category] || 1.0)\n  * seasonMultiplier;\n\n// Apply cap ($500 max per mission)\nconst maxReward = 500;\nif (finalReward > maxReward) {\n  finalReward = maxReward;\n}\n\n// Round to 2 decimal places\nfinalReward = Math.round(finalReward * 100) / 100;\n\nreturn {\n  json: {\n    ...item,\n    reward_calculation: {\n      base_rate: baseRate,\n      grade_multiplier: gradeMultiplier[item.grade] || 1.0,\n      category_bonus: categoryBonus[item.category] || 1.0,\n      season_multiplier: seasonMultiplier,\n      base_reward: baseReward.toFixed(2),\n      final_reward: finalReward,\n      capped: finalReward >= maxReward\n    }\n  }\n};"
      },
      "id": "code-reward",
      "name": "Calculate Dynamic Reward",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 300]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ë‹¹ì‹ ì€ í”Œë«í¼ ë³´ì•ˆ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. í¬ë¦¬ì—ì´í„°ì˜ ì¡°íšŒìˆ˜ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬ ì–´ë·°ì§•(Abusing) í™•ë¥ ì„ í‰ê°€í•˜ì„¸ìš”.\n\n[í¬ë¦¬ì—ì´í„° ë°ì´í„°]\n- Username: {{ $json.username }}\n- ì´ ì¡°íšŒìˆ˜: {{ $json.views }}\n- ì¢‹ì•„ìš”: {{ $json.likes }}\n- ëŒ“ê¸€: {{ $json.comments }}\n- í‰ê·  ì‹œì²­ ì‹œê°„: {{ $json.avg_watch_time }}ì´ˆ\n- ì¡°íšŒìˆ˜ ì¶”ì´ (ì‹œê°„ë³„): {{ JSON.stringify($json.view_history) }}\n- í”¼í¬ ì‹œê°„ëŒ€: {{ $json.peak_hour }}ì‹œ\n- ì°¸ì—¬ìœ¨: {{ $json.engagement_rate }}%\n\n[ì–´ë·°ì§• íƒì§€ ê¸°ì¤€]\n1. ìƒˆë²½ ì‹œê°„ëŒ€(02:00-05:00)ì— ê¸‰ê²©í•œ ìˆ˜ì§ ìƒìŠ¹ì´ ìˆëŠ”ê°€? (ë´‡ ì˜ì‹¬)\n2. ì¢‹ì•„ìš”/ëŒ“ê¸€ ë¹„ìœ¨ì´ ì¡°íšŒìˆ˜ ëŒ€ë¹„ ë¹„ì •ìƒì ìœ¼ë¡œ ë‚®ì€ê°€? (< 1%)\n3. í‰ê·  ì‹œì²­ ì‹œê°„ì´ 3ì´ˆ ë¯¸ë§Œì¸ê°€? (í´ë¦­íŒœ ì˜ì‹¬)\n4. ì¡°íšŒìˆ˜ ê¸‰ë“±ì´ ìì—°ìŠ¤ëŸ¬ìš´ ê³¡ì„ ì´ ì•„ë‹Œ ê³„ë‹¨ì‹ì¸ê°€?\n\n[ì¶œë ¥ í˜•ì‹ - ë°˜ë“œì‹œ JSON]\n{\n  \"risk_score\": 0-100 ì‚¬ì´ì˜ ì •ìˆ˜,\n  \"risk_level\": \"LOW\" | \"MEDIUM\" | \"HIGH\" | \"CRITICAL\",\n  \"detected_patterns\": [\"íƒì§€ëœ ì˜ì‹¬ íŒ¨í„´ ëª©ë¡\"],\n  \"recommendation\": \"APPROVE\" | \"REVIEW\" | \"HOLD\" | \"REJECT\",\n  \"reason\": \"íŒë‹¨ ê·¼ê±° ìƒì„¸ ì„¤ëª…\",\n  \"confidence\": 0-100 ì‚¬ì´ì˜ ì‹ ë¢°ë„\n}",
        "options": {
          "systemMessage": "ë‹¹ì‹ ì€ ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… í”Œë«í¼ì˜ Fraud Detection System(FDS) ì „ë¬¸ê°€ì…ë‹ˆë‹¤.\n\ní•µì‹¬ ì›ì¹™:\n1. ì •ìƒì ì¸ ë°”ì´ëŸ´ê³¼ ì¸ìœ„ì ì¸ ì–´ë·°ì§•ì„ êµ¬ë¶„í•©ë‹ˆë‹¤.\n2. False Positiveë¥¼ ìµœì†Œí™”í•˜ë©´ì„œë„ ì–´ë·°ì§•ì€ ë°˜ë“œì‹œ íƒì§€í•©ë‹ˆë‹¤.\n3. ëª¨ë“  ì‘ë‹µì€ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤.\n4. risk_scoreê°€ 70 ì´ìƒì´ë©´ HIGH, 85 ì´ìƒì´ë©´ CRITICALë¡œ ë¶„ë¥˜í•©ë‹ˆë‹¤."
        }
      },
      "id": "ai-fds",
      "name": "AI Fraud Detection",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [880, 300]
    },
    {
      "parameters": {
        "model": "gpt-4-turbo",
        "options": {
          "temperature": 0.3,
          "maxTokens": 1500
        }
      },
      "id": "openai-fds",
      "name": "OpenAI GPT-4 (FDS)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [880, 520]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// Parse FDS AI response\nconst item = $input.item.json;\nconst aiResponse = item.output || item.text || '';\n\nlet fdsResult;\ntry {\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    fdsResult = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No JSON found');\n  }\n} catch (e) {\n  fdsResult = {\n    risk_score: 50,\n    risk_level: 'MEDIUM',\n    detected_patterns: ['Parse error - manual review required'],\n    recommendation: 'REVIEW',\n    reason: 'AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨',\n    confidence: 0\n  };\n}\n\n// Determine final action\nlet settlement_status;\nlet settlement_action;\n\nif (fdsResult.risk_score >= 85) {\n  settlement_status = 'BLOCKED';\n  settlement_action = 'Account flagged for investigation';\n} else if (fdsResult.risk_score >= 70) {\n  settlement_status = 'HOLD';\n  settlement_action = 'Payment held pending review';\n} else if (fdsResult.risk_score >= 50) {\n  settlement_status = 'REVIEW';\n  settlement_action = 'Manual verification required';\n} else {\n  settlement_status = 'APPROVED';\n  settlement_action = 'Auto-approved for payment';\n}\n\nreturn {\n  json: {\n    creator_id: item.creator_id,\n    username: item.username,\n    views: item.views,\n    reward: item.reward_calculation?.final_reward || 0,\n    fds_result: fdsResult,\n    settlement_status: settlement_status,\n    settlement_action: settlement_action,\n    settlement_date: new Date().toISOString().split('T')[0],\n    transaction_id: `TXN-${Date.now()}-${Math.random().toString(36).substr(2, 6).toUpperCase()}`\n  }\n};"
      },
      "id": "code-fds-parse",
      "name": "Process FDS Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1100, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "condition-high-risk",
              "leftValue": "={{ $json.fds_result.risk_score }}",
              "rightValue": 70,
              "operator": {
                "type": "number",
                "operation": "gte"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-risk",
      "name": "Check Risk Level",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [1320, 300]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "post",
        "channel": {
          "__rl": true,
          "mode": "name",
          "value": "#risk-alerts"
        },
        "text": "=ğŸš¨ *[FRAUD ALERT - High Risk Detected]*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ‘¤ *Creator*: {{ $json.username }}\nğŸ†” *ID*: {{ $json.creator_id }}\nğŸ“Š *Transaction*: {{ $json.transaction_id }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš ï¸ *Risk Assessment*\nâ€¢ Score: *{{ $json.fds_result.risk_score }}/100*\nâ€¢ Level: *{{ $json.fds_result.risk_level }}*\nâ€¢ Confidence: {{ $json.fds_result.confidence }}%\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ” *Detected Patterns*\n{{ $json.fds_result.detected_patterns.map(p => 'â€¢ ' + p).join('\\n') }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° *Settlement Impact*\nâ€¢ Views: {{ $json.views.toLocaleString() }}\nâ€¢ Calculated Reward: ${{ $json.reward }}\nâ€¢ Status: *{{ $json.settlement_status }}*\nâ€¢ Action: {{ $json.settlement_action }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“‹ *Reason*\n{{ $json.fds_result.reason }}\n\n_Recommendation: {{ $json.fds_result.recommendation }}_",
        "otherOptions": {}
      },
      "id": "slack-risk",
      "name": "Alert: High Risk",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1540, 200]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "post",
        "channel": {
          "__rl": true,
          "mode": "name",
          "value": "#settlements"
        },
        "text": "=âœ… *[Settlement Approved]*\n\nğŸ‘¤ {{ $json.username }}\nğŸ’° ${{ $json.reward }} â†’ Payment Queue\nğŸ“Š Views: {{ $json.views.toLocaleString() }}\nğŸ” Risk Score: {{ $json.fds_result.risk_score }}/100 ({{ $json.fds_result.risk_level }})\n\n_TXN: {{ $json.transaction_id }}_",
        "otherOptions": {}
      },
      "id": "slack-approved",
      "name": "Log: Approved Settlement",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1540, 400]
    }
  ],
  "connections": {
    "Daily 6AM Settlement": {
      "main": [
        [{ "node": "Get Creator View Data (Mock)", "type": "main", "index": 0 }]
      ]
    },
    "Get Creator View Data (Mock)": {
      "main": [
        [{ "node": "Prepare Settlement Data", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Settlement Data": {
      "main": [
        [{ "node": "Calculate Dynamic Reward", "type": "main", "index": 0 }]
      ]
    },
    "Calculate Dynamic Reward": {
      "main": [
        [{ "node": "AI Fraud Detection", "type": "main", "index": 0 }]
      ]
    },
    "OpenAI GPT-4 (FDS)": {
      "ai_languageModel": [
        [{ "node": "AI Fraud Detection", "type": "ai_languageModel", "index": 0 }]
      ]
    },
    "AI Fraud Detection": {
      "main": [
        [{ "node": "Process FDS Result", "type": "main", "index": 0 }]
      ]
    },
    "Process FDS Result": {
      "main": [
        [{ "node": "Check Risk Level", "type": "main", "index": 0 }]
      ]
    },
    "Check Risk Level": {
      "main": [
        [{ "node": "Alert: High Risk", "type": "main", "index": 0 }],
        [{ "node": "Log: Approved Settlement", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "timezone": "Asia/Seoul"
  },
  "staticData": null,
  "tags": [
    { "name": "Monetization" },
    { "name": "FDS" },
    { "name": "Risk Management" }
  ],
  "triggerCount": 1,
  "updatedAt": "2024-11-26T00:00:00.000Z",
  "versionId": "1"
}
