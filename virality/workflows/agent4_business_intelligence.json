{
  "name": "Agent 4 - Business Intelligence (WBR)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "weeks",
              "triggerAtDay": 1,
              "triggerAtHour": 8
            }
          ]
        }
      },
      "id": "schedule-weekly",
      "name": "Monday 8AM WBR Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://jsonplaceholder.typicode.com/posts",
        "options": {}
      },
      "id": "http-revenue",
      "name": "Get Revenue Data (Mock)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [220, 150],
      "notes": "Replace with Postgres/Stripe API"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://jsonplaceholder.typicode.com/users",
        "options": {}
      },
      "id": "http-creators",
      "name": "Get Creator Metrics (Mock)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [220, 300],
      "notes": "Replace with Analytics DB"
    },
    {
      "parameters": {
        "method": "GET",
        "url": "https://jsonplaceholder.typicode.com/comments",
        "options": {}
      },
      "id": "http-missions",
      "name": "Get Mission Metrics (Mock)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [220, 450],
      "notes": "Replace with Mission DB"
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Weekly Business Review Data Aggregation\n// In production, replace with actual database queries\n\nconst currentWeek = getWeekNumber(new Date());\nconst previousWeek = currentWeek - 1;\n\nfunction getWeekNumber(d) {\n  d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));\n  d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));\n  const yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));\n  return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);\n}\n\nconst mockWBRData = {\n  report_period: {\n    week: currentWeek,\n    year: new Date().getFullYear(),\n    start_date: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\n    end_date: new Date().toISOString().split('T')[0]\n  },\n  \n  // Revenue Metrics\n  revenue: {\n    total_payout: 4500,\n    previous_week: 3900,\n    wow_change: 15.4,\n    avg_cpv: 0.0008,\n    target_cpv: 0.001,\n    cpv_status: 'HEALTHY',\n    breakdown_by_category: {\n      'Lifestyle': { payout: 1800, percentage: 40 },\n      'Tech': { payout: 1350, percentage: 30 },\n      'Food': { payout: 900, percentage: 20 },\n      'Beauty': { payout: 450, percentage: 10 }\n    }\n  },\n  \n  // Creator Ecosystem\n  creators: {\n    wau: 245,\n    previous_wau: 258,\n    wau_change: -5.0,\n    total_registered: 1250,\n    new_this_week: 45,\n    churn_this_week: 12,\n    active_rate: 19.6,\n    grade_distribution: {\n      'S': 15,\n      'A': 48,\n      'B': 112,\n      'C': 70\n    },\n    top_performers: [\n      { username: '@sarah_lifestyle', views: 250000, earnings: 185 },\n      { username: '@tech_mike', views: 180000, earnings: 142 },\n      { username: '@food_jenny', views: 165000, earnings: 128 }\n    ]\n  },\n  \n  // Mission Performance\n  missions: {\n    active_missions: 24,\n    completed_this_week: 156,\n    avg_completion_rate: 34.5,\n    avg_views_per_mission: 45000,\n    top_performing_mission: {\n      title: 'ë°ìŠ¤í¬í…Œë¦¬ì–´ ê¿€í…œ ì†Œê°œí•˜ê³  $30 ë°›ê¸°',\n      views: 520000,\n      submissions: 45,\n      category: 'Lifestyle'\n    },\n    underperforming: [\n      { title: 'ë·°í‹° ë£¨í‹´ ê³µìœ ', category: 'Beauty', completion_rate: 12 }\n    ]\n  },\n  \n  // Risk & Fraud\n  risk: {\n    fraud_blocked_amount: 350,\n    blocked_users: 2,\n    warning_issued: 5,\n    false_positive_rate: 2.1,\n    incidents: [\n      { user: '@user_991', pattern: 'Bot Traffic', amount_blocked: 280, status: 'BANNED' },\n      { user: '@user_102', pattern: 'Low Quality Engagement', amount_blocked: 70, status: 'WARNING' }\n    ]\n  },\n  \n  // Key Issues & Alerts\n  alerts: [\n    {\n      severity: 'WARNING',\n      category: 'Creator Retention',\n      message: 'WAUê°€ ì „ì£¼ ëŒ€ë¹„ 5% í•˜ë½',\n      impact: 'Medium',\n      suggested_action: 'ì´íƒˆ í¬ë¦¬ì—ì´í„° ëŒ€ìƒ ë¦¬í…ì…˜ ìº í˜ì¸ ê²€í† '\n    },\n    {\n      severity: 'INFO',\n      category: 'Category Performance',\n      message: 'Beauty ì¹´í…Œê³ ë¦¬ CPVê°€ $0.0012ë¡œ ë‹¤ì†Œ ë†’ìŒ',\n      impact: 'Low',\n      suggested_action: 'ì˜ˆì‚° ì¬ë°°ì • ê²€í†  (Beauty â†’ Lifestyle)'\n    }\n  ]\n};\n\nreturn [{ json: mockWBRData }];"
      },
      "id": "code-aggregate",
      "name": "Aggregate WBR Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [440, 300]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ë‹¹ì‹ ì€ Senior Business Analystì…ë‹ˆë‹¤. Weekly Business Review ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ê²½ì˜ì§„ì„ ìœ„í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ìƒì„±í•˜ì„¸ìš”.\n\n[Report Period]\n- Week {{ $json.report_period.week }}, {{ $json.report_period.year }}\n- {{ $json.report_period.start_date }} ~ {{ $json.report_period.end_date }}\n\n[Revenue Metrics]\n- Total Payout: ${{ $json.revenue.total_payout }} (WoW: {{ $json.revenue.wow_change > 0 ? '+' : '' }}{{ $json.revenue.wow_change }}%)\n- Avg CPV: ${{ $json.revenue.avg_cpv }} (Target: ${{ $json.revenue.target_cpv }}, Status: {{ $json.revenue.cpv_status }})\n- Category Breakdown: {{ JSON.stringify($json.revenue.breakdown_by_category) }}\n\n[Creator Ecosystem]\n- WAU: {{ $json.creators.wau }} (WoW: {{ $json.creators.wau_change }}%)\n- New Creators: {{ $json.creators.new_this_week }}, Churned: {{ $json.creators.churn_this_week }}\n- Active Rate: {{ $json.creators.active_rate }}%\n- Grade Distribution: {{ JSON.stringify($json.creators.grade_distribution) }}\n- Top Performers: {{ JSON.stringify($json.creators.top_performers) }}\n\n[Mission Performance]\n- Active Missions: {{ $json.missions.active_missions }}\n- Completed This Week: {{ $json.missions.completed_this_week }}\n- Avg Completion Rate: {{ $json.missions.avg_completion_rate }}%\n- Top Mission: {{ $json.missions.top_performing_mission.title }} ({{ $json.missions.top_performing_mission.views.toLocaleString() }} views)\n- Underperforming: {{ JSON.stringify($json.missions.underperforming) }}\n\n[Risk & Fraud]\n- Fraud Blocked: ${{ $json.risk.fraud_blocked_amount }}\n- Users Blocked: {{ $json.risk.blocked_users }}, Warnings: {{ $json.risk.warning_issued }}\n- Incidents: {{ JSON.stringify($json.risk.incidents) }}\n\n[Current Alerts]\n{{ JSON.stringify($json.alerts, null, 2) }}\n\n[ë¶„ì„ ìš”ì²­]\n1. í•µì‹¬ ì„±ê³¼ ì§€í‘œ(KPI)ì— ëŒ€í•œ Executive Summaryë¥¼ ì‘ì„±í•˜ì„¸ìš”.\n2. WAU í•˜ë½ì˜ ì ì¬ì  ì›ì¸ê³¼ ëŒ€ì‘ ë°©ì•ˆì„ ë¶„ì„í•˜ì„¸ìš”.\n3. ì¹´í…Œê³ ë¦¬ë³„ ìˆ˜ìµì„± ë¶„ì„ ë° ì˜ˆì‚° ì¬ë°°ì • ê¶Œê³ ì‚¬í•­ì„ ì œì‹œí•˜ì„¸ìš”.\n4. ë‹¤ìŒ ì£¼ ìš°ì„ ìˆœìœ„ Action Itemsë¥¼ 3-5ê°œ ë„ì¶œí•˜ì„¸ìš”.\n5. ë¦¬ìŠ¤í¬ ìš”ì¸ê³¼ mitigation ì „ëµì„ ì œì•ˆí•˜ì„¸ìš”.\n\n[ì¶œë ¥ í˜•ì‹ - JSON]\n{\n  \"executive_summary\": \"ê²½ì˜ì§„ ë³´ê³ ìš© 3-4ë¬¸ì¥ ìš”ì•½\",\n  \"health_score\": {\n    \"overall\": 0-100,\n    \"revenue\": 0-100,\n    \"creators\": 0-100,\n    \"missions\": 0-100,\n    \"risk\": 0-100\n  },\n  \"key_insights\": [\n    {\n      \"category\": \"ì¸ì‚¬ì´íŠ¸ ì¹´í…Œê³ ë¦¬\",\n      \"insight\": \"ë°œê²¬ ì‚¬í•­\",\n      \"impact\": \"HIGH/MEDIUM/LOW\",\n      \"trend\": \"UP/DOWN/STABLE\"\n    }\n  ],\n  \"wau_analysis\": {\n    \"root_causes\": [\"WAU í•˜ë½ ì›ì¸ë“¤\"],\n    \"retention_strategies\": [\"ë¦¬í…ì…˜ ì „ëµë“¤\"]\n  },\n  \"category_recommendations\": {\n    \"reallocate_from\": \"ì¹´í…Œê³ ë¦¬\",\n    \"reallocate_to\": \"ì¹´í…Œê³ ë¦¬\",\n    \"percentage\": \"ë¹„ìœ¨\",\n    \"rationale\": \"ê·¼ê±°\"\n  },\n  \"action_items\": [\n    {\n      \"priority\": 1-5,\n      \"action\": \"ì‹¤í–‰ í•­ëª©\",\n      \"owner\": \"ë‹´ë‹¹ì/íŒ€\",\n      \"deadline\": \"ê¸°í•œ\",\n      \"expected_impact\": \"ì˜ˆìƒ íš¨ê³¼\"\n    }\n  ],\n  \"risks\": [\n    {\n      \"risk\": \"ë¦¬ìŠ¤í¬ ìš”ì¸\",\n      \"probability\": \"HIGH/MEDIUM/LOW\",\n      \"impact\": \"HIGH/MEDIUM/LOW\",\n      \"mitigation\": \"ì™„í™” ì „ëµ\"\n    }\n  ],\n  \"next_week_forecast\": {\n    \"expected_payout\": \"ì˜ˆìƒ ì§€ê¸‰ì•¡\",\n    \"expected_wau\": \"ì˜ˆìƒ WAU\",\n    \"key_focus_areas\": [\"ì§‘ì¤‘ ì˜ì—­ë“¤\"]\n  }\n}",
        "options": {
          "systemMessage": "ë‹¹ì‹ ì€ ì¸í”Œë£¨ì–¸ì„œ ë§ˆì¼€íŒ… í”Œë«í¼ì˜ Senior Business Analystì…ë‹ˆë‹¤.\n\ní•µì‹¬ ì›ì¹™:\n1. ë°ì´í„° ê¸°ë°˜ì˜ ê°ê´€ì  ë¶„ì„ì„ ì œê³µí•©ë‹ˆë‹¤.\n2. ì‹¤í–‰ ê°€ëŠ¥í•œ Action Itemsë¥¼ ë„ì¶œí•©ë‹ˆë‹¤.\n3. ë¦¬ìŠ¤í¬ì™€ ê¸°íšŒë¥¼ ê· í˜•ìˆê²Œ ì œì‹œí•©ë‹ˆë‹¤.\n4. ê²½ì˜ì§„ì´ ë¹ ë¥´ê²Œ ì˜ì‚¬ê²°ì •í•  ìˆ˜ ìˆë„ë¡ ëª…í™•í•˜ê²Œ ìš”ì•½í•©ë‹ˆë‹¤.\n5. ëª¨ë“  ì‘ë‹µì€ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤."
        }
      },
      "id": "ai-wbr",
      "name": "AI Business Analyst",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [660, 300]
    },
    {
      "parameters": {
        "model": "gpt-4-turbo",
        "options": {
          "temperature": 0.5,
          "maxTokens": 3000
        }
      },
      "id": "openai-wbr",
      "name": "OpenAI GPT-4 (WBR)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [660, 520]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Parse AI analysis and prepare final WBR report\nconst wbrData = $('Aggregate WBR Data').first().json;\nconst aiResponse = $input.first().json.output || $input.first().json.text || '';\n\nlet analysis;\ntry {\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    analysis = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No JSON found');\n  }\n} catch (e) {\n  analysis = {\n    executive_summary: 'AI ë¶„ì„ íŒŒì‹± ì‹¤íŒ¨ - ìˆ˜ë™ ê²€í†  í•„ìš”',\n    health_score: { overall: 0 },\n    action_items: [{ priority: 1, action: 'AI ì‘ë‹µ ìˆ˜ë™ ê²€í† ', owner: 'PM' }],\n    raw_response: aiResponse\n  };\n}\n\nconst reportId = `WBR-${wbrData.report_period.year}-W${wbrData.report_period.week}`;\n\nreturn [{\n  json: {\n    report_id: reportId,\n    generated_at: new Date().toISOString(),\n    period: wbrData.report_period,\n    raw_metrics: {\n      revenue: wbrData.revenue,\n      creators: wbrData.creators,\n      missions: wbrData.missions,\n      risk: wbrData.risk\n    },\n    alerts: wbrData.alerts,\n    ai_analysis: analysis,\n    pdf_link: `https://your-storage.com/reports/${reportId}.pdf`\n  }\n}];"
      },
      "id": "code-report",
      "name": "Generate WBR Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [880, 300]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "post",
        "channel": {
          "__rl": true,
          "mode": "name",
          "value": "#weekly-business-review"
        },
        "text": "=ğŸ“Š *[Weekly Business Review]*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nğŸ“‹ *{{ $json.report_id }}*\nğŸ“… Week {{ $json.period.week }}, {{ $json.period.year }}\nğŸ• Generated: {{ $json.generated_at }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¯ *EXECUTIVE SUMMARY*\n{{ $json.ai_analysis.executive_summary }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ“ˆ *HEALTH SCORES*\nğŸŸ¢ Overall: {{ $json.ai_analysis.health_score?.overall || 'N/A' }}/100\nğŸ’° Revenue: {{ $json.ai_analysis.health_score?.revenue || 'N/A' }}/100\nğŸ‘¥ Creators: {{ $json.ai_analysis.health_score?.creators || 'N/A' }}/100\nğŸ¯ Missions: {{ $json.ai_analysis.health_score?.missions || 'N/A' }}/100\nğŸ›¡ï¸ Risk: {{ $json.ai_analysis.health_score?.risk || 'N/A' }}/100\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ’° *KEY METRICS*\nâ€¢ Total Payout: *${{ $json.raw_metrics.revenue.total_payout }}* ({{ $json.raw_metrics.revenue.wow_change > 0 ? '+' : '' }}{{ $json.raw_metrics.revenue.wow_change }}% WoW)\nâ€¢ WAU: *{{ $json.raw_metrics.creators.wau }}* ({{ $json.raw_metrics.creators.wau_change }}% WoW)\nâ€¢ Avg CPV: ${{ $json.raw_metrics.revenue.avg_cpv }} âœ…\nâ€¢ Fraud Blocked: ${{ $json.raw_metrics.risk.fraud_blocked_amount }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâš ï¸ *ALERTS*\n{{ $json.alerts.map(a => `${a.severity === 'WARNING' ? 'ğŸ”¶' : 'â„¹ï¸'} [${a.category}] ${a.message}`).join('\\n') }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nâœ… *ACTION ITEMS*\n{{ ($json.ai_analysis.action_items || []).slice(0, 5).map((item, i) => `${i+1}. *${item.action}* (${item.owner || 'TBD'}) - ${item.deadline || 'ASAP'}`).join('\\n') }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ† *TOP PERFORMERS*\n{{ $json.raw_metrics.creators.top_performers.map((c, i) => `${i+1}. ${c.username} - ${c.views.toLocaleString()} views ($${c.earnings})`).join('\\n') }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ‘‰ <{{ $json.pdf_link }}|Full Report PDF>",
        "otherOptions": {}
      },
      "id": "slack-wbr",
      "name": "Slack: WBR Report",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [1100, 200]
    },
    {
      "parameters": {
        "sendTo": "={{ $env.EXECUTIVE_EMAIL || 'ceo@example.com' }}",
        "subject": "=[WBR] Week {{ $json.period.week }} Business Review - Health Score: {{ $json.ai_analysis.health_score?.overall || 'N/A' }}/100",
        "emailType": "html",
        "message": "=<h1>ğŸ“Š Weekly Business Review</h1>\n<p><strong>{{ $json.report_id }}</strong> | Week {{ $json.period.week }}, {{ $json.period.year }}</p>\n\n<h2>ğŸ¯ Executive Summary</h2>\n<p>{{ $json.ai_analysis.executive_summary }}</p>\n\n<h2>ğŸ“ˆ Key Metrics</h2>\n<table border=\"1\" cellpadding=\"10\">\n<tr><td><strong>Total Payout</strong></td><td>${{ $json.raw_metrics.revenue.total_payout }} ({{ $json.raw_metrics.revenue.wow_change > 0 ? '+' : '' }}{{ $json.raw_metrics.revenue.wow_change }}%)</td></tr>\n<tr><td><strong>WAU</strong></td><td>{{ $json.raw_metrics.creators.wau }} ({{ $json.raw_metrics.creators.wau_change }}%)</td></tr>\n<tr><td><strong>Fraud Blocked</strong></td><td>${{ $json.raw_metrics.risk.fraud_blocked_amount }}</td></tr>\n</table>\n\n<h2>âœ… Priority Actions</h2>\n<ol>\n{{ ($json.ai_analysis.action_items || []).slice(0, 5).map(item => '<li><strong>' + item.action + '</strong> - ' + (item.owner || 'TBD') + '</li>').join('') }}\n</ol>\n\n<p><a href=\"{{ $json.pdf_link }}\">Download Full Report (PDF)</a></p>",
        "options": {}
      },
      "id": "email-executive",
      "name": "Email: Executive Report",
      "type": "n8n-nodes-base.gmail",
      "typeVersion": 2.1,
      "position": [1100, 400],
      "notes": "Configure Gmail credentials"
    }
  ],
  "connections": {
    "Monday 8AM WBR Trigger": {
      "main": [
        [
          { "node": "Get Revenue Data (Mock)", "type": "main", "index": 0 },
          { "node": "Get Creator Metrics (Mock)", "type": "main", "index": 0 },
          { "node": "Get Mission Metrics (Mock)", "type": "main", "index": 0 }
        ]
      ]
    },
    "Get Revenue Data (Mock)": {
      "main": [
        [{ "node": "Aggregate WBR Data", "type": "main", "index": 0 }]
      ]
    },
    "Get Creator Metrics (Mock)": {
      "main": [
        [{ "node": "Aggregate WBR Data", "type": "main", "index": 0 }]
      ]
    },
    "Get Mission Metrics (Mock)": {
      "main": [
        [{ "node": "Aggregate WBR Data", "type": "main", "index": 0 }]
      ]
    },
    "Aggregate WBR Data": {
      "main": [
        [{ "node": "AI Business Analyst", "type": "main", "index": 0 }]
      ]
    },
    "OpenAI GPT-4 (WBR)": {
      "ai_languageModel": [
        [{ "node": "AI Business Analyst", "type": "ai_languageModel", "index": 0 }]
      ]
    },
    "AI Business Analyst": {
      "main": [
        [{ "node": "Generate WBR Report", "type": "main", "index": 0 }]
      ]
    },
    "Generate WBR Report": {
      "main": [
        [
          { "node": "Slack: WBR Report", "type": "main", "index": 0 },
          { "node": "Email: Executive Report", "type": "main", "index": 0 }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "timezone": "Asia/Seoul"
  },
  "staticData": null,
  "tags": [
    { "name": "Business Intelligence" },
    { "name": "WBR" },
    { "name": "Analytics" }
  ],
  "triggerCount": 1,
  "updatedAt": "2024-11-26T00:00:00.000Z",
  "versionId": "1"
}
