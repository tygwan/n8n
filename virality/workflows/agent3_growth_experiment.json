{
  "name": "Agent 3 - Growth Experiment (A/B Testing)",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "mission-click",
        "options": {}
      },
      "id": "webhook-click",
      "name": "Mission Click Webhook",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [0, 200],
      "webhookId": "mission-click-webhook"
    },
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "days",
              "triggerAtHour": 9
            }
          ]
        }
      },
      "id": "schedule-report",
      "name": "Daily Report Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [0, 500]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// A/B Test Group Assignment\n// Uses consistent hashing based on user_id\n\nconst crypto = require('crypto');\nconst input = $input.first().json;\n\nconst userId = input.user_id || `user_${Date.now()}`;\nconst experimentId = 'EXP_2024_MISSION_COPY_V2';\n\n// Create consistent hash for user\nconst hash = crypto.createHash('md5').update(userId).digest('hex');\nconst segment = parseInt(hash.substring(0, 8), 16) % 100;\n\n// 50:50 split\nconst assignedGroup = segment < 50 ? 'A' : 'B';\n\n// Group configurations\nconst groupConfig = {\n  'A': {\n    copy_type: 'emotional',\n    mission_title: 'ë‹¹ì‹ ì˜ ìž¬ëŠ¥ì„ ì„¸ìƒì— ë³´ì—¬ì£¼ì„¸ìš”',\n    cta_text: 'ì§€ê¸ˆ ì°¸ì—¬í•˜ê¸°',\n    color_scheme: 'warm',\n    emoji: 'âœ¨'\n  },\n  'B': {\n    copy_type: 'reward',\n    mission_title: 'ì´ ì˜ìƒ í•˜ë‚˜ë¡œ $50 ë²Œê¸°',\n    cta_text: 'ì§€ê¸ˆ ë°”ë¡œ ìˆ˜ìµ ì°½ì¶œ',\n    color_scheme: 'bold',\n    emoji: 'ðŸ’°'\n  }\n};\n\nreturn [{\n  json: {\n    user_id: userId,\n    experiment_id: experimentId,\n    assigned_group: assignedGroup,\n    segment_number: segment,\n    timestamp: new Date().toISOString(),\n    ...groupConfig[assignedGroup],\n    original_request: input\n  }\n}];"
      },
      "id": "code-ab-split",
      "name": "A/B Group Assignment",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 200]
    },
    {
      "parameters": {
        "mode": "rules",
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.assigned_group }}",
                    "rightValue": "A",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Group A"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict"
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.assigned_group }}",
                    "rightValue": "B",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "Group B"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-group",
      "name": "Route by Group",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [440, 200]
    },
    {
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "response-a",
              "name": "response",
              "value": "={{ { user_id: $json.user_id, experiment_id: $json.experiment_id, group: 'A', mission: { title: $json.mission_title, cta: $json.cta_text, style: $json.color_scheme, emoji: $json.emoji }, tracking_pixel: 'https://track.example.com/exp/' + $json.experiment_id + '/A/' + $json.user_id } }}",
              "type": "object"
            }
          ]
        }
      },
      "id": "set-response-a",
      "name": "Prepare Group A Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [660, 100]
    },
    {
      "parameters": {
        "mode": "manual",
        "duplicateItem": false,
        "assignments": {
          "assignments": [
            {
              "id": "response-b",
              "name": "response",
              "value": "={{ { user_id: $json.user_id, experiment_id: $json.experiment_id, group: 'B', mission: { title: $json.mission_title, cta: $json.cta_text, style: $json.color_scheme, emoji: $json.emoji }, tracking_pixel: 'https://track.example.com/exp/' + $json.experiment_id + '/B/' + $json.user_id } }}",
              "type": "object"
            }
          ]
        }
      },
      "id": "set-response-b",
      "name": "Prepare Group B Response",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [660, 300]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json.response }}",
        "options": {}
      },
      "id": "respond-webhook",
      "name": "Respond to Webhook",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [880, 200]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Aggregate A/B Test Results for Daily Report\n// In production, this would query your analytics database\n\nconst mockResults = {\n  experiment_id: 'EXP_2024_MISSION_COPY_V2',\n  experiment_name: 'Mission Copy Optimization',\n  period: {\n    start: new Date(Date.now() - 3 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],\n    end: new Date().toISOString().split('T')[0],\n    days: 3\n  },\n  hypothesis: 'ê°ì„±ì  í˜¸ì†Œë³´ë‹¤ êµ¬ì²´ì  ë³´ìƒ ê¸ˆì•¡($)ì„ ì œëª©ì— ë…¸ì¶œí•  ë•Œ, ë¯¸ì…˜ í´ë¦­ë¥ (CTR)ì´ 10% ì´ìƒ ìƒìŠ¹í•  ê²ƒì´ë‹¤.',\n  groups: {\n    A: {\n      name: 'Control (Emotional)',\n      copy: 'ë‹¹ì‹ ì˜ ìž¬ëŠ¥ì„ ì„¸ìƒì— ë³´ì—¬ì£¼ì„¸ìš”',\n      impressions: 1500,\n      clicks: 75,\n      starts: 45,\n      submissions: 12,\n      ctr: 5.0,\n      start_rate: 60.0,\n      completion_rate: 26.7\n    },\n    B: {\n      name: 'Test (Reward)',\n      copy: 'ì´ ì˜ìƒ í•˜ë‚˜ë¡œ $50 ë²Œê¸°',\n      impressions: 1480,\n      clicks: 133,\n      starts: 95,\n      submissions: 25,\n      ctr: 9.0,\n      start_rate: 71.4,\n      completion_rate: 26.3\n    }\n  },\n  analysis: {\n    ctr_lift: 80.0,\n    ctr_lift_percentage: '+4.0%p',\n    start_rate_lift: 19.0,\n    sample_size_sufficient: true,\n    min_detectable_effect: 0.02\n  }\n};\n\n// Calculate statistical significance (simplified)\nconst groupA = mockResults.groups.A;\nconst groupB = mockResults.groups.B;\n\nconst pooledCtr = (groupA.clicks + groupB.clicks) / (groupA.impressions + groupB.impressions);\nconst se = Math.sqrt(pooledCtr * (1 - pooledCtr) * (1/groupA.impressions + 1/groupB.impressions));\nconst zScore = (groupB.ctr/100 - groupA.ctr/100) / se;\nconst pValue = 2 * (1 - normalCDF(Math.abs(zScore)));\n\nfunction normalCDF(x) {\n  const a1 = 0.254829592, a2 = -0.284496736, a3 = 1.421413741;\n  const a4 = -1.453152027, a5 = 1.061405429, p = 0.3275911;\n  const sign = x < 0 ? -1 : 1;\n  x = Math.abs(x) / Math.sqrt(2);\n  const t = 1.0 / (1.0 + p * x);\n  const y = 1.0 - (((((a5 * t + a4) * t) + a3) * t + a2) * t + a1) * t * Math.exp(-x * x);\n  return 0.5 * (1.0 + sign * y);\n}\n\nmockResults.statistical_analysis = {\n  z_score: zScore.toFixed(3),\n  p_value: pValue.toFixed(4),\n  significant_at_95: pValue < 0.05,\n  significant_at_99: pValue < 0.01,\n  confidence_level: pValue < 0.001 ? '99.9%' : pValue < 0.01 ? '99%' : pValue < 0.05 ? '95%' : 'Not significant'\n};\n\n// Determine winner\nmockResults.winner = {\n  group: 'B',\n  name: mockResults.groups.B.name,\n  recommendation: pValue < 0.05 ? 'DEPLOY' : 'CONTINUE_TEST',\n  confidence: mockResults.statistical_analysis.confidence_level\n};\n\nreturn [{ json: mockResults }];"
      },
      "id": "code-aggregate",
      "name": "Aggregate Experiment Data",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [220, 500]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ë‹¹ì‹ ì€ Growth PMì´ìž ë°ì´í„° ë¶„ì„ê°€ìž…ë‹ˆë‹¤. A/B í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ê³  ì˜ì‚¬ê²°ì •ì„ ì§€ì›í•˜ì„¸ìš”.\n\n[ì‹¤í—˜ ì •ë³´]\n- ì‹¤í—˜ ID: {{ $json.experiment_id }}\n- ì‹¤í—˜ëª…: {{ $json.experiment_name }}\n- ê¸°ê°„: {{ $json.period.start }} ~ {{ $json.period.end }} ({{ $json.period.days }}ì¼)\n- ê°€ì„¤: {{ $json.hypothesis }}\n\n[Group A - Control (ê°ì„± ì†Œêµ¬)]\n- ì¹´í”¼: \"{{ $json.groups.A.copy }}\"\n- ë…¸ì¶œ: {{ $json.groups.A.impressions }}\n- í´ë¦­: {{ $json.groups.A.clicks }} (CTR: {{ $json.groups.A.ctr }}%)\n- ì‹œìž‘: {{ $json.groups.A.starts }} (ì‹œìž‘ë¥ : {{ $json.groups.A.start_rate }}%)\n- ì œì¶œ: {{ $json.groups.A.submissions }} (ì™„ë£Œìœ¨: {{ $json.groups.A.completion_rate }}%)\n\n[Group B - Test (ë³´ìƒ ì†Œêµ¬)]\n- ì¹´í”¼: \"{{ $json.groups.B.copy }}\"\n- ë…¸ì¶œ: {{ $json.groups.B.impressions }}\n- í´ë¦­: {{ $json.groups.B.clicks }} (CTR: {{ $json.groups.B.ctr }}%)\n- ì‹œìž‘: {{ $json.groups.B.starts }} (ì‹œìž‘ë¥ : {{ $json.groups.B.start_rate }}%)\n- ì œì¶œ: {{ $json.groups.B.submissions }} (ì™„ë£Œìœ¨: {{ $json.groups.B.completion_rate }}%)\n\n[í†µê³„ ë¶„ì„]\n- Z-Score: {{ $json.statistical_analysis.z_score }}\n- P-Value: {{ $json.statistical_analysis.p_value }}\n- 95% ì‹ ë¢°ìˆ˜ì¤€ ìœ ì˜: {{ $json.statistical_analysis.significant_at_95 }}\n- ì‹ ë¢°ë„: {{ $json.statistical_analysis.confidence_level }}\n\n[ë¶„ì„ ìš”ì²­]\n1. ê°€ì„¤ì´ ê²€ì¦ë˜ì—ˆëŠ”ì§€ íŒë‹¨í•˜ì„¸ìš”.\n2. CTR ë¿ë§Œ ì•„ë‹ˆë¼ ì „ì²´ í¼ë„(ë…¸ì¶œâ†’í´ë¦­â†’ì‹œìž‘â†’ì œì¶œ)ì„ ë¶„ì„í•˜ì„¸ìš”.\n3. ë‹¤ìŒ ë²„ì „(v0.3)ì— ì ìš©í•  ê¶Œê³ ì‚¬í•­ì„ ì œì‹œí•˜ì„¸ìš”.\n4. í›„ì† ì‹¤í—˜ ì•„ì´ë””ì–´ë¥¼ 2-3ê°œ ì œì•ˆí•˜ì„¸ìš”.\n\n[ì¶œë ¥ í˜•ì‹ - JSON]\n{\n  \"hypothesis_validated\": true/false,\n  \"winner\": \"A\" | \"B\" | \"No clear winner\",\n  \"key_findings\": [\"ì£¼ìš” ë°œê²¬ì‚¬í•­ ëª©ë¡\"],\n  \"funnel_analysis\": {\n    \"ctr_insight\": \"CTR ë¶„ì„ ì¸ì‚¬ì´íŠ¸\",\n    \"start_rate_insight\": \"ì‹œìž‘ë¥  ë¶„ì„ ì¸ì‚¬ì´íŠ¸\",\n    \"completion_insight\": \"ì™„ë£Œìœ¨ ë¶„ì„ ì¸ì‚¬ì´íŠ¸\"\n  },\n  \"recommendation\": {\n    \"action\": \"DEPLOY_B\" | \"DEPLOY_A\" | \"CONTINUE_TEST\" | \"REDESIGN\",\n    \"rationale\": \"ê¶Œê³  ê·¼ê±°\",\n    \"implementation_note\": \"v0.3 ì ìš© ì‹œ ì£¼ì˜ì‚¬í•­\"\n  },\n  \"next_experiments\": [\n    {\n      \"hypothesis\": \"í›„ì† ì‹¤í—˜ ê°€ì„¤\",\n      \"variants\": [\"í…ŒìŠ¤íŠ¸í•  ë³€í˜•ë“¤\"],\n      \"expected_impact\": \"ì˜ˆìƒ ì˜í–¥\"\n    }\n  ],\n  \"executive_summary\": \"ê²½ì˜ì§„ ë³´ê³ ìš© 1-2ë¬¸ìž¥ ìš”ì•½\"\n}",
        "options": {
          "systemMessage": "ë‹¹ì‹ ì€ ë°ì´í„° ê¸°ë°˜ ì˜ì‚¬ê²°ì •ì„ ì§€ì›í•˜ëŠ” Growth PMìž…ë‹ˆë‹¤.\n\ní•µì‹¬ ì›ì¹™:\n1. í†µê³„ì  ìœ ì˜ì„±ì„ ë°˜ë“œì‹œ í™•ì¸í•©ë‹ˆë‹¤.\n2. ë‹¨ì¼ ì§€í‘œê°€ ì•„ë‹Œ ì „ì²´ í¼ë„ì„ ë¶„ì„í•©ë‹ˆë‹¤.\n3. ì‹¤í–‰ ê°€ëŠ¥í•œ ì¸ì‚¬ì´íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤.\n4. ëª¨ë“  ì‘ë‹µì€ JSON í˜•ì‹ìœ¼ë¡œ ì¶œë ¥í•©ë‹ˆë‹¤."
        }
      },
      "id": "ai-analysis",
      "name": "AI Statistical Analysis",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [440, 500]
    },
    {
      "parameters": {
        "model": "gpt-4-turbo",
        "options": {
          "temperature": 0.4,
          "maxTokens": 2500
        }
      },
      "id": "openai-analysis",
      "name": "OpenAI GPT-4 (Analysis)",
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [440, 720]
    },
    {
      "parameters": {
        "mode": "runOnceForAllItems",
        "jsCode": "// Parse AI analysis and prepare report\nconst experimentData = $('Aggregate Experiment Data').first().json;\nconst aiResponse = $input.first().json.output || $input.first().json.text || '';\n\nlet analysis;\ntry {\n  const jsonMatch = aiResponse.match(/\\{[\\s\\S]*\\}/);\n  if (jsonMatch) {\n    analysis = JSON.parse(jsonMatch[0]);\n  } else {\n    throw new Error('No JSON found');\n  }\n} catch (e) {\n  analysis = {\n    hypothesis_validated: null,\n    winner: 'Parse Error',\n    executive_summary: aiResponse,\n    recommendation: { action: 'MANUAL_REVIEW', rationale: 'AI ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨' }\n  };\n}\n\nreturn [{\n  json: {\n    report_id: `GR-${new Date().toISOString().split('T')[0]}-${experimentData.experiment_id}`,\n    report_date: new Date().toISOString(),\n    experiment: experimentData,\n    ai_analysis: analysis\n  }\n}];"
      },
      "id": "code-report",
      "name": "Generate Report",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [660, 500]
    },
    {
      "parameters": {
        "resource": "message",
        "operation": "post",
        "channel": {
          "__rl": true,
          "mode": "name",
          "value": "#growth-experiments"
        },
        "text": "=ðŸ“Š *[Daily Growth Report]*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\nðŸ“‹ *Report ID*: {{ $json.report_id }}\nðŸ§ª *Experiment*: {{ $json.experiment.experiment_name }}\nðŸ“… *Period*: {{ $json.experiment.period.start }} ~ {{ $json.experiment.period.end }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸŽ¯ *Hypothesis*\n{{ $json.experiment.hypothesis }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“ˆ *Results Summary*\n\n*Group A (Control)*: \"{{ $json.experiment.groups.A.copy }}\"\nâ€¢ CTR: {{ $json.experiment.groups.A.ctr }}%\nâ€¢ Starts: {{ $json.experiment.groups.A.starts }}\nâ€¢ Submissions: {{ $json.experiment.groups.A.submissions }}\n\n*Group B (Test)*: \"{{ $json.experiment.groups.B.copy }}\"\nâ€¢ CTR: {{ $json.experiment.groups.B.ctr }}% _({{ $json.experiment.analysis.ctr_lift_percentage }})_\nâ€¢ Starts: {{ $json.experiment.groups.B.starts }}\nâ€¢ Submissions: {{ $json.experiment.groups.B.submissions }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ“Š *Statistical Significance*\nâ€¢ P-Value: {{ $json.experiment.statistical_analysis.p_value }}\nâ€¢ Confidence: *{{ $json.experiment.statistical_analysis.confidence_level }}*\nâ€¢ Winner: *{{ $json.ai_analysis.winner || $json.experiment.winner.group }}*\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ’¡ *AI Analysis*\n{{ $json.ai_analysis.executive_summary }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸŽ¬ *Recommendation*\n*Action*: {{ $json.ai_analysis.recommendation?.action || 'N/A' }}\n{{ $json.ai_analysis.recommendation?.rationale || '' }}\n\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nðŸ”¬ *Next Experiments*\n{{ ($json.ai_analysis.next_experiments || []).map((e, i) => `${i+1}. ${e.hypothesis}`).join('\\n') || 'N/A' }}",
        "otherOptions": {}
      },
      "id": "slack-report",
      "name": "Slack: Growth Report",
      "type": "n8n-nodes-base.slack",
      "typeVersion": 2.2,
      "position": [880, 500]
    }
  ],
  "connections": {
    "Mission Click Webhook": {
      "main": [
        [{ "node": "A/B Group Assignment", "type": "main", "index": 0 }]
      ]
    },
    "A/B Group Assignment": {
      "main": [
        [{ "node": "Route by Group", "type": "main", "index": 0 }]
      ]
    },
    "Route by Group": {
      "main": [
        [{ "node": "Prepare Group A Response", "type": "main", "index": 0 }],
        [{ "node": "Prepare Group B Response", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Group A Response": {
      "main": [
        [{ "node": "Respond to Webhook", "type": "main", "index": 0 }]
      ]
    },
    "Prepare Group B Response": {
      "main": [
        [{ "node": "Respond to Webhook", "type": "main", "index": 0 }]
      ]
    },
    "Daily Report Trigger": {
      "main": [
        [{ "node": "Aggregate Experiment Data", "type": "main", "index": 0 }]
      ]
    },
    "Aggregate Experiment Data": {
      "main": [
        [{ "node": "AI Statistical Analysis", "type": "main", "index": 0 }]
      ]
    },
    "OpenAI GPT-4 (Analysis)": {
      "ai_languageModel": [
        [{ "node": "AI Statistical Analysis", "type": "ai_languageModel", "index": 0 }]
      ]
    },
    "AI Statistical Analysis": {
      "main": [
        [{ "node": "Generate Report", "type": "main", "index": 0 }]
      ]
    },
    "Generate Report": {
      "main": [
        [{ "node": "Slack: Growth Report", "type": "main", "index": 0 }]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveDataErrorExecution": "all",
    "saveDataSuccessExecution": "all",
    "timezone": "Asia/Seoul"
  },
  "staticData": null,
  "tags": [
    { "name": "Growth" },
    { "name": "A/B Testing" },
    { "name": "Experiment" }
  ],
  "triggerCount": 2,
  "updatedAt": "2024-11-26T00:00:00.000Z",
  "versionId": "1"
}
